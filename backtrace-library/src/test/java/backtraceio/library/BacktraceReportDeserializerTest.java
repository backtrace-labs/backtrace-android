package backtraceio.library;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertNotNull;
import static org.junit.Assert.assertNull;
import static org.junit.Assert.assertTrue;

import com.google.gson.GsonBuilder;

import org.json.JSONException;
import org.json.JSONObject;
import org.junit.Test;

import java.util.HashMap;

import backtraceio.library.common.BacktraceSerializeHelper;
import backtraceio.library.common.serialization.BacktraceGsonBuilder;
import backtraceio.library.common.serializers.deserializers.BacktraceReportDeserializer;
import backtraceio.library.common.serializers.deserializers.BacktraceResultDeserializer;
import backtraceio.library.models.BacktraceResult;
import backtraceio.library.models.json.BacktraceReport;
import backtraceio.library.models.types.BacktraceResultStatus;

// TODO: move to standard unit tests not instrumented
public class BacktraceReportDeserializerTest {
    @Test
    public void deserializeCoronerApiJsonResponse() throws JSONException {
        // GIVEN
        String json3 = "{\"response\":\"Ok\",\"_rxid\":\"01000000-5360-240b-0000-000000000000\"}";
        String json = "{\"uuid\":\"39407c49-0999-438b-bfac-140c83d2521b\",\"timestamp\":1704901251,\"exception-type-report\":true,\"classifier\":\"java.lang.Exception\",\"attributes\":{\"error.type\":\"Exception\",\"test\":{\"detail-message\":\"123\",\"stack-trace\":[],\"suppressed-exceptions\":[]}},\"exception\":{\"detail-message\":\"test\",\"stack-trace\":[{\"class-loader-name\":\"app\",\"declaring-class\":\"backtraceio.library.BacktraceReportDeserializerTest\",\"method-name\":\"deserializeCoronerApiJsonResponse\",\"file-name\":\"BacktraceReportDeserializerTest.java\",\"line-number\":28,\"format\":1},{\"module-name\":\"java.base\",\"module-version\":\"11.0.15\",\"declaring-class\":\"jdk.internal.reflect.NativeMethodAccessorImpl\",\"method-name\":\"invoke0\",\"file-name\":\"NativeMethodAccessorImpl.java\",\"line-number\":-2,\"format\":2},{\"module-name\":\"java.base\",\"module-version\":\"11.0.15\",\"declaring-class\":\"jdk.internal.reflect.NativeMethodAccessorImpl\",\"method-name\":\"invoke\",\"file-name\":\"NativeMethodAccessorImpl.java\",\"line-number\":62,\"format\":2},{\"module-name\":\"java.base\",\"module-version\":\"11.0.15\",\"declaring-class\":\"jdk.internal.reflect.DelegatingMethodAccessorImpl\",\"method-name\":\"invoke\",\"file-name\":\"DelegatingMethodAccessorImpl.java\",\"line-number\":43,\"format\":2},{\"module-name\":\"java.base\",\"module-version\":\"11.0.15\",\"declaring-class\":\"java.lang.reflect.Method\",\"method-name\":\"invoke\",\"file-name\":\"Method.java\",\"line-number\":566,\"format\":2},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.runners.model.FrameworkMethod$1\",\"method-name\":\"runReflectiveCall\",\"file-name\":\"FrameworkMethod.java\",\"line-number\":59,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.internal.runners.model.ReflectiveCallable\",\"method-name\":\"run\",\"file-name\":\"ReflectiveCallable.java\",\"line-number\":12,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.runners.model.FrameworkMethod\",\"method-name\":\"invokeExplosively\",\"file-name\":\"FrameworkMethod.java\",\"line-number\":56,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.internal.runners.statements.InvokeMethod\",\"method-name\":\"evaluate\",\"file-name\":\"InvokeMethod.java\",\"line-number\":17,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.runners.ParentRunner$3\",\"method-name\":\"evaluate\",\"file-name\":\"ParentRunner.java\",\"line-number\":306,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.runners.BlockJUnit4ClassRunner$1\",\"method-name\":\"evaluate\",\"file-name\":\"BlockJUnit4ClassRunner.java\",\"line-number\":100,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.runners.ParentRunner\",\"method-name\":\"runLeaf\",\"file-name\":\"ParentRunner.java\",\"line-number\":366,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.runners.BlockJUnit4ClassRunner\",\"method-name\":\"runChild\",\"file-name\":\"BlockJUnit4ClassRunner.java\",\"line-number\":103,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.runners.BlockJUnit4ClassRunner\",\"method-name\":\"runChild\",\"file-name\":\"BlockJUnit4ClassRunner.java\",\"line-number\":63,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.runners.ParentRunner$4\",\"method-name\":\"run\",\"file-name\":\"ParentRunner.java\",\"line-number\":331,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.runners.ParentRunner$1\",\"method-name\":\"schedule\",\"file-name\":\"ParentRunner.java\",\"line-number\":79,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.runners.ParentRunner\",\"method-name\":\"runChildren\",\"file-name\":\"ParentRunner.java\",\"line-number\":329,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.runners.ParentRunner\",\"method-name\":\"access$100\",\"file-name\":\"ParentRunner.java\",\"line-number\":66,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.runners.ParentRunner$2\",\"method-name\":\"evaluate\",\"file-name\":\"ParentRunner.java\",\"line-number\":293,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.runners.ParentRunner$3\",\"method-name\":\"evaluate\",\"file-name\":\"ParentRunner.java\",\"line-number\":306,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.runners.ParentRunner\",\"method-name\":\"run\",\"file-name\":\"ParentRunner.java\",\"line-number\":413,\"format\":1},{\"declaring-class\":\"org.gradle.api.internal.tasks.testing.junit.JUnitTestClassExecutor\",\"method-name\":\"runTestClass\",\"file-name\":\"JUnitTestClassExecutor.java\",\"line-number\":110,\"format\":0},{\"declaring-class\":\"org.gradle.api.internal.tasks.testing.junit.JUnitTestClassExecutor\",\"method-name\":\"execute\",\"file-name\":\"JUnitTestClassExecutor.java\",\"line-number\":58,\"format\":0},{\"declaring-class\":\"org.gradle.api.internal.tasks.testing.junit.JUnitTestClassExecutor\",\"method-name\":\"execute\",\"file-name\":\"JUnitTestClassExecutor.java\",\"line-number\":38,\"format\":0},{\"declaring-class\":\"org.gradle.api.internal.tasks.testing.junit.AbstractJUnitTestClassProcessor\",\"method-name\":\"processTestClass\",\"file-name\":\"AbstractJUnitTestClassProcessor.java\",\"line-number\":62,\"format\":0},{\"declaring-class\":\"org.gradle.api.internal.tasks.testing.SuiteTestClassProcessor\",\"method-name\":\"processTestClass\",\"file-name\":\"SuiteTestClassProcessor.java\",\"line-number\":51,\"format\":0},{\"module-name\":\"java.base\",\"module-version\":\"11.0.15\",\"declaring-class\":\"jdk.internal.reflect.NativeMethodAccessorImpl\",\"method-name\":\"invoke0\",\"file-name\":\"NativeMethodAccessorImpl.java\",\"line-number\":-2,\"format\":2},{\"module-name\":\"java.base\",\"module-version\":\"11.0.15\",\"declaring-class\":\"jdk.internal.reflect.NativeMethodAccessorImpl\",\"method-name\":\"invoke\",\"file-name\":\"NativeMethodAccessorImpl.java\",\"line-number\":62,\"format\":2},{\"module-name\":\"java.base\",\"module-version\":\"11.0.15\",\"declaring-class\":\"jdk.internal.reflect.DelegatingMethodAccessorImpl\",\"method-name\":\"invoke\",\"file-name\":\"DelegatingMethodAccessorImpl.java\",\"line-number\":43,\"format\":2},{\"module-name\":\"java.base\",\"module-version\":\"11.0.15\",\"declaring-class\":\"java.lang.reflect.Method\",\"method-name\":\"invoke\",\"file-name\":\"Method.java\",\"line-number\":566,\"format\":2},{\"declaring-class\":\"org.gradle.internal.dispatch.ReflectionDispatch\",\"method-name\":\"dispatch\",\"file-name\":\"ReflectionDispatch.java\",\"line-number\":36,\"format\":0},{\"declaring-class\":\"org.gradle.internal.dispatch.ReflectionDispatch\",\"method-name\":\"dispatch\",\"file-name\":\"ReflectionDispatch.java\",\"line-number\":24,\"format\":0},{\"declaring-class\":\"org.gradle.internal.dispatch.ContextClassLoaderDispatch\",\"method-name\":\"dispatch\",\"file-name\":\"ContextClassLoaderDispatch.java\",\"line-number\":33,\"format\":0},{\"declaring-class\":\"org.gradle.internal.dispatch.ProxyDispatchAdapter$DispatchingInvocationHandler\",\"method-name\":\"invoke\",\"file-name\":\"ProxyDispatchAdapter.java\",\"line-number\":94,\"format\":0},{\"declaring-class\":\"com.sun.proxy.$Proxy5\",\"method-name\":\"processTestClass\",\"line-number\":-1,\"format\":0},{\"declaring-class\":\"org.gradle.api.internal.tasks.testing.worker.TestWorker$2\",\"method-name\":\"run\",\"file-name\":\"TestWorker.java\",\"line-number\":176,\"format\":0},{\"declaring-class\":\"org.gradle.api.internal.tasks.testing.worker.TestWorker\",\"method-name\":\"executeAndMaintainThreadName\",\"file-name\":\"TestWorker.java\",\"line-number\":129,\"format\":0},{\"declaring-class\":\"org.gradle.api.internal.tasks.testing.worker.TestWorker\",\"method-name\":\"execute\",\"file-name\":\"TestWorker.java\",\"line-number\":100,\"format\":0},{\"declaring-class\":\"org.gradle.api.internal.tasks.testing.worker.TestWorker\",\"method-name\":\"execute\",\"file-name\":\"TestWorker.java\",\"line-number\":60,\"format\":0},{\"declaring-class\":\"org.gradle.process.internal.worker.child.ActionExecutionWorker\",\"method-name\":\"execute\",\"file-name\":\"ActionExecutionWorker.java\",\"line-number\":56,\"format\":0},{\"declaring-class\":\"org.gradle.process.internal.worker.child.SystemApplicationClassLoaderWorker\",\"method-name\":\"call\",\"file-name\":\"SystemApplicationClassLoaderWorker.java\",\"line-number\":133,\"format\":0},{\"declaring-class\":\"org.gradle.process.internal.worker.child.SystemApplicationClassLoaderWorker\",\"method-name\":\"call\",\"file-name\":\"SystemApplicationClassLoaderWorker.java\",\"line-number\":71,\"format\":0},{\"class-loader-name\":\"app\",\"declaring-class\":\"worker.org.gradle.process.internal.worker.GradleWorkerMain\",\"method-name\":\"run\",\"file-name\":\"GradleWorkerMain.java\",\"line-number\":69,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"worker.org.gradle.process.internal.worker.GradleWorkerMain\",\"method-name\":\"main\",\"file-name\":\"GradleWorkerMain.java\",\"line-number\":74,\"format\":1}],\"suppressed-exceptions\":[]},\"attachment-paths\":[],\"diagnostic-stack\":[{\"function-name\":\"jdk.internal.reflect.NativeMethodAccessorImpl.invoke0\",\"source-code\":\"09abddfa-f0b4-4c7b-8d4d-b5974b63ddbe\"},{\"function-name\":\"jdk.internal.reflect.NativeMethodAccessorImpl.invoke\",\"line\":62,\"source-code\":\"0e1d692e-c09d-4fc4-b79e-a10d5a2f1784\"},{\"function-name\":\"jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke\",\"line\":43,\"source-code\":\"f10bf34f-ebc9-448f-923c-d8d95d1e902c\"},{\"function-name\":\"java.lang.reflect.Method.invoke\",\"line\":566,\"source-code\":\"9dd50221-77de-4390-8e58-dd80d4e3d334\"},{\"function-name\":\"org.junit.runners.model.FrameworkMethod$1.runReflectiveCall\",\"line\":59,\"source-code\":\"6dfc62ec-cacb-4b1f-bd10-910d302b17d9\"},{\"function-name\":\"org.junit.internal.runners.model.ReflectiveCallable.run\",\"line\":12,\"source-code\":\"bfee006e-e2fc-4495-a9af-918b1d2a0b21\"},{\"function-name\":\"org.junit.runners.model.FrameworkMethod.invokeExplosively\",\"line\":56,\"source-code\":\"2c93a559-ce6a-4198-b0d5-f8eaf3e7d9e7\"},{\"function-name\":\"org.junit.internal.runners.statements.InvokeMethod.evaluate\",\"line\":17,\"source-code\":\"51bb3a68-0fa8-4fb6-892b-31814389a6e8\"},{\"function-name\":\"org.junit.runners.ParentRunner$3.evaluate\",\"line\":306,\"source-code\":\"25d86bea-22d1-4860-80b9-7c9bcc57fbbc\"},{\"function-name\":\"org.junit.runners.BlockJUnit4ClassRunner$1.evaluate\",\"line\":100,\"source-code\":\"02809e4b-14d7-4e59-a294-a96a4faef2f9\"},{\"function-name\":\"org.junit.runners.ParentRunner.runLeaf\",\"line\":366,\"source-code\":\"bafc405c-f6ed-4f43-8488-21ee7c69ceb9\"},{\"function-name\":\"org.junit.runners.BlockJUnit4ClassRunner.runChild\",\"line\":103,\"source-code\":\"c58d0aa9-62ad-4299-8917-ac03f08968da\"},{\"function-name\":\"org.junit.runners.BlockJUnit4ClassRunner.runChild\",\"line\":63,\"source-code\":\"784c5ee6-5705-4160-8f2f-4130af14b07f\"},{\"function-name\":\"org.junit.runners.ParentRunner$4.run\",\"line\":331,\"source-code\":\"d196c71a-5d5d-4c2f-9971-1ecf09c7c249\"},{\"function-name\":\"org.junit.runners.ParentRunner$1.schedule\",\"line\":79,\"source-code\":\"90fb8c3f-d9cf-4c51-b64f-4a0fb2828c5a\"},{\"function-name\":\"org.junit.runners.ParentRunner.runChildren\",\"line\":329,\"source-code\":\"d57386c0-c987-4e9e-84a6-5392be9c05fa\"},{\"function-name\":\"org.junit.runners.ParentRunner.access$100\",\"line\":66,\"source-code\":\"def6f727-70d7-40a8-945d-ad1200ab902f\"},{\"function-name\":\"org.junit.runners.ParentRunner$2.evaluate\",\"line\":293,\"source-code\":\"1715c216-399a-4149-812b-e4df6a84383a\"},{\"function-name\":\"org.junit.runners.ParentRunner$3.evaluate\",\"line\":306,\"source-code\":\"b944ea20-59e7-4a27-b04c-f6d0bbd56641\"},{\"function-name\":\"org.junit.runners.ParentRunner.run\",\"line\":413,\"source-code\":\"8fd59a49-370a-4037-aa3b-897d9f23cbd7\"},{\"function-name\":\"org.gradle.api.internal.tasks.testing.junit.JUnitTestClassExecutor.runTestClass\",\"line\":110,\"source-code\":\"ffff8d16-dbd9-46d9-a66d-66ea9ea09b2e\"},{\"function-name\":\"org.gradle.api.internal.tasks.testing.junit.JUnitTestClassExecutor.execute\",\"line\":58,\"source-code\":\"2d51c1ef-31b9-4cb6-8e7a-fd532655374c\"},{\"function-name\":\"org.gradle.api.internal.tasks.testing.junit.JUnitTestClassExecutor.execute\",\"line\":38,\"source-code\":\"838bf886-e97d-4e86-a4f3-519399c47d45\"},{\"function-name\":\"org.gradle.api.internal.tasks.testing.junit.AbstractJUnitTestClassProcessor.processTestClass\",\"line\":62,\"source-code\":\"c53e74a7-7461-43a3-943c-2f30b76c12fb\"},{\"function-name\":\"org.gradle.api.internal.tasks.testing.SuiteTestClassProcessor.processTestClass\",\"line\":51,\"source-code\":\"c7c1f43b-bd91-49e2-b037-cfff36d704be\"},{\"function-name\":\"jdk.internal.reflect.NativeMethodAccessorImpl.invoke0\",\"source-code\":\"64223e3c-e9f1-4e10-bdb6-3017c6065c0d\"},{\"function-name\":\"jdk.internal.reflect.NativeMethodAccessorImpl.invoke\",\"line\":62,\"source-code\":\"30077941-0ca3-4262-910b-e247ddddc536\"},{\"function-name\":\"jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke\",\"line\":43,\"source-code\":\"7c553ce5-9c83-4c15-8371-e1e2888b551a\"},{\"function-name\":\"java.lang.reflect.Method.invoke\",\"line\":566,\"source-code\":\"95e942c1-39e2-4a8c-8a6d-bfdeb5ccd769\"},{\"function-name\":\"org.gradle.internal.dispatch.ReflectionDispatch.dispatch\",\"line\":36,\"source-code\":\"4148f823-3c5c-4cd9-8581-164da1674e76\"},{\"function-name\":\"org.gradle.internal.dispatch.ReflectionDispatch.dispatch\",\"line\":24,\"source-code\":\"d3d0bc8d-b044-4dc0-8005-02d0dcb4c696\"},{\"function-name\":\"org.gradle.internal.dispatch.ContextClassLoaderDispatch.dispatch\",\"line\":33,\"source-code\":\"700c3d9c-9a29-4187-bfbe-75aee9bba6cd\"},{\"function-name\":\"org.gradle.internal.dispatch.ProxyDispatchAdapter$DispatchingInvocationHandler.invoke\",\"line\":94,\"source-code\":\"8ba21c2a-6ad1-4aff-8109-4f67c0155b5f\"},{\"function-name\":\"com.sun.proxy.$Proxy5.processTestClass\",\"source-code\":\"ccab4c45-b9d0-4165-93f0-17515e650f82\"},{\"function-name\":\"org.gradle.api.internal.tasks.testing.worker.TestWorker$2.run\",\"line\":176,\"source-code\":\"1be123e0-0320-4900-a22e-103e541b2e6a\"},{\"function-name\":\"org.gradle.api.internal.tasks.testing.worker.TestWorker.executeAndMaintainThreadName\",\"line\":129,\"source-code\":\"25e0fa54-6be5-402f-9fff-f1270d9af06d\"},{\"function-name\":\"org.gradle.api.internal.tasks.testing.worker.TestWorker.execute\",\"line\":100,\"source-code\":\"e987481f-feac-4e56-96ec-1cfd615b58dc\"},{\"function-name\":\"org.gradle.api.internal.tasks.testing.worker.TestWorker.execute\",\"line\":60,\"source-code\":\"395d0d24-420b-471f-92aa-4f1e066b08f9\"},{\"function-name\":\"org.gradle.process.internal.worker.child.ActionExecutionWorker.execute\",\"line\":56,\"source-code\":\"9a5a94f7-bb4d-45e9-98ef-db9bf4d29daf\"},{\"function-name\":\"org.gradle.process.internal.worker.child.SystemApplicationClassLoaderWorker.call\",\"line\":133,\"source-code\":\"99a8df6d-5ce1-4831-a7b8-b999e28791fa\"},{\"function-name\":\"org.gradle.process.internal.worker.child.SystemApplicationClassLoaderWorker.call\",\"line\":71,\"source-code\":\"8c1c5455-ef76-4bf9-b96b-2c7e551cd172\"},{\"function-name\":\"worker.org.gradle.process.internal.worker.GradleWorkerMain.run\",\"line\":69,\"source-code\":\"ba96ce9d-e712-4c87-a54e-86d1de170962\"},{\"function-name\":\"worker.org.gradle.process.internal.worker.GradleWorkerMain.main\",\"line\":74,\"source-code\":\"519557ac-72b3-4fc9-b6eb-6f3a201aeb0c\"}]}";
        // WHEN
        String json2 = BacktraceSerializeHelper.toJson(new BacktraceReport(new Exception("test"), new HashMap<String, Object>() {{ put("test", new Exception("123")); }} ));
        BacktraceReportDeserializer deserializer = new BacktraceReportDeserializer();
        BacktraceReport result2 = BacktraceSerializeHelper.fromJson(new BacktraceGsonBuilder().buildGson(), json, BacktraceReport.class);
        BacktraceReport result = deserializer.deserialize(new JSONObject(json));

        // THEN
        assertNotNull(result);
        assertEquals("39407c49-0999-438b-bfac-140c83d2521b", result.uuid.toString());
        assertEquals(1704901251, result.timestamp);
        assertTrue(result.exceptionTypeReport);
        assertEquals("java.lang.Exception", result.classifier);
        assertNull(result.message);
//        assertNull(result.getBacktraceReport());
//        assertNull(result.message);
//        assertEquals(BacktraceResultStatus.Ok, result.status);
//        assertEquals("01000000-5360-240b-0000-000000000000", result.rxId);
    }

    // TODO: Add test case with another response e.g. server error
}

package backtraceio.library;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertNotNull;
import static org.junit.Assert.assertNull;
import static org.junit.Assert.assertTrue;

import com.google.gson.Gson;

import org.json.JSONException;
import org.json.JSONObject;
import org.junit.Test;

import java.util.HashMap;

import backtraceio.library.common.BacktraceSerializeHelper;
import backtraceio.library.common.serialization.BacktraceGsonBuilder;
import backtraceio.library.common.serialization.DebugHelper;
import backtraceio.library.common.serializers.deserializers.BacktraceReportDeserializer;
import backtraceio.library.models.json.BacktraceReport;

public class BacktraceReportDeserializerTest {
    @Test
    public void deserializeCoronerApiJsonResponse() throws JSONException {
        // GIVEN
        String json3 = "{\"response\":\"Ok\",\"_rxid\":\"01000000-5360-240b-0000-000000000000\"}";
        String json = "{\"uuid\":\"444d7674-378c-48fd-9b51-d961c3bba3ab\",\"timestamp\":1704905258,\"exception-type-report\":true,\"classifier\":\"java.lang.IllegalAccessException\",\"attributes\":{\"error.type\":\"Exception\",\"test\":{\"detail-message\":\"123\",\"stack-trace\":[],\"suppressed-exceptions\":[]}},\"exception\":{\"detail-message\":\"test\",\"stack-trace\":[{\"class-loader-name\":\"app\",\"declaring-class\":\"backtraceio.library.BacktraceReportDeserializerTest\",\"method-name\":\"deserializeCoronerApiJsonResponse\",\"file-name\":\"BacktraceReportDeserializerTest.java\",\"line-number\":32,\"format\":1},{\"module-name\":\"java.base\",\"module-version\":\"11.0.15\",\"declaring-class\":\"jdk.internal.reflect.NativeMethodAccessorImpl\",\"method-name\":\"invoke0\",\"file-name\":\"NativeMethodAccessorImpl.java\",\"line-number\":-2,\"format\":2},{\"module-name\":\"java.base\",\"module-version\":\"11.0.15\",\"declaring-class\":\"jdk.internal.reflect.NativeMethodAccessorImpl\",\"method-name\":\"invoke\",\"file-name\":\"NativeMethodAccessorImpl.java\",\"line-number\":62,\"format\":2},{\"module-name\":\"java.base\",\"module-version\":\"11.0.15\",\"declaring-class\":\"jdk.internal.reflect.DelegatingMethodAccessorImpl\",\"method-name\":\"invoke\",\"file-name\":\"DelegatingMethodAccessorImpl.java\",\"line-number\":43,\"format\":2},{\"module-name\":\"java.base\",\"module-version\":\"11.0.15\",\"declaring-class\":\"java.lang.reflect.Method\",\"method-name\":\"invoke\",\"file-name\":\"Method.java\",\"line-number\":566,\"format\":2},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.runners.model.FrameworkMethod$1\",\"method-name\":\"runReflectiveCall\",\"file-name\":\"FrameworkMethod.java\",\"line-number\":59,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.internal.runners.model.ReflectiveCallable\",\"method-name\":\"run\",\"file-name\":\"ReflectiveCallable.java\",\"line-number\":12,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.runners.model.FrameworkMethod\",\"method-name\":\"invokeExplosively\",\"file-name\":\"FrameworkMethod.java\",\"line-number\":56,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.internal.runners.statements.InvokeMethod\",\"method-name\":\"evaluate\",\"file-name\":\"InvokeMethod.java\",\"line-number\":17,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.runners.ParentRunner$3\",\"method-name\":\"evaluate\",\"file-name\":\"ParentRunner.java\",\"line-number\":306,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.runners.BlockJUnit4ClassRunner$1\",\"method-name\":\"evaluate\",\"file-name\":\"BlockJUnit4ClassRunner.java\",\"line-number\":100,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.runners.ParentRunner\",\"method-name\":\"runLeaf\",\"file-name\":\"ParentRunner.java\",\"line-number\":366,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.runners.BlockJUnit4ClassRunner\",\"method-name\":\"runChild\",\"file-name\":\"BlockJUnit4ClassRunner.java\",\"line-number\":103,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.runners.BlockJUnit4ClassRunner\",\"method-name\":\"runChild\",\"file-name\":\"BlockJUnit4ClassRunner.java\",\"line-number\":63,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.runners.ParentRunner$4\",\"method-name\":\"run\",\"file-name\":\"ParentRunner.java\",\"line-number\":331,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.runners.ParentRunner$1\",\"method-name\":\"schedule\",\"file-name\":\"ParentRunner.java\",\"line-number\":79,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.runners.ParentRunner\",\"method-name\":\"runChildren\",\"file-name\":\"ParentRunner.java\",\"line-number\":329,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.runners.ParentRunner\",\"method-name\":\"access$100\",\"file-name\":\"ParentRunner.java\",\"line-number\":66,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.runners.ParentRunner$2\",\"method-name\":\"evaluate\",\"file-name\":\"ParentRunner.java\",\"line-number\":293,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.runners.ParentRunner$3\",\"method-name\":\"evaluate\",\"file-name\":\"ParentRunner.java\",\"line-number\":306,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"org.junit.runners.ParentRunner\",\"method-name\":\"run\",\"file-name\":\"ParentRunner.java\",\"line-number\":413,\"format\":1},{\"declaring-class\":\"org.gradle.api.internal.tasks.testing.junit.JUnitTestClassExecutor\",\"method-name\":\"runTestClass\",\"file-name\":\"JUnitTestClassExecutor.java\",\"line-number\":110,\"format\":0},{\"declaring-class\":\"org.gradle.api.internal.tasks.testing.junit.JUnitTestClassExecutor\",\"method-name\":\"execute\",\"file-name\":\"JUnitTestClassExecutor.java\",\"line-number\":58,\"format\":0},{\"declaring-class\":\"org.gradle.api.internal.tasks.testing.junit.JUnitTestClassExecutor\",\"method-name\":\"execute\",\"file-name\":\"JUnitTestClassExecutor.java\",\"line-number\":38,\"format\":0},{\"declaring-class\":\"org.gradle.api.internal.tasks.testing.junit.AbstractJUnitTestClassProcessor\",\"method-name\":\"processTestClass\",\"file-name\":\"AbstractJUnitTestClassProcessor.java\",\"line-number\":62,\"format\":0},{\"declaring-class\":\"org.gradle.api.internal.tasks.testing.SuiteTestClassProcessor\",\"method-name\":\"processTestClass\",\"file-name\":\"SuiteTestClassProcessor.java\",\"line-number\":51,\"format\":0},{\"module-name\":\"java.base\",\"module-version\":\"11.0.15\",\"declaring-class\":\"jdk.internal.reflect.NativeMethodAccessorImpl\",\"method-name\":\"invoke0\",\"file-name\":\"NativeMethodAccessorImpl.java\",\"line-number\":-2,\"format\":2},{\"module-name\":\"java.base\",\"module-version\":\"11.0.15\",\"declaring-class\":\"jdk.internal.reflect.NativeMethodAccessorImpl\",\"method-name\":\"invoke\",\"file-name\":\"NativeMethodAccessorImpl.java\",\"line-number\":62,\"format\":2},{\"module-name\":\"java.base\",\"module-version\":\"11.0.15\",\"declaring-class\":\"jdk.internal.reflect.DelegatingMethodAccessorImpl\",\"method-name\":\"invoke\",\"file-name\":\"DelegatingMethodAccessorImpl.java\",\"line-number\":43,\"format\":2},{\"module-name\":\"java.base\",\"module-version\":\"11.0.15\",\"declaring-class\":\"java.lang.reflect.Method\",\"method-name\":\"invoke\",\"file-name\":\"Method.java\",\"line-number\":566,\"format\":2},{\"declaring-class\":\"org.gradle.internal.dispatch.ReflectionDispatch\",\"method-name\":\"dispatch\",\"file-name\":\"ReflectionDispatch.java\",\"line-number\":36,\"format\":0},{\"declaring-class\":\"org.gradle.internal.dispatch.ReflectionDispatch\",\"method-name\":\"dispatch\",\"file-name\":\"ReflectionDispatch.java\",\"line-number\":24,\"format\":0},{\"declaring-class\":\"org.gradle.internal.dispatch.ContextClassLoaderDispatch\",\"method-name\":\"dispatch\",\"file-name\":\"ContextClassLoaderDispatch.java\",\"line-number\":33,\"format\":0},{\"declaring-class\":\"org.gradle.internal.dispatch.ProxyDispatchAdapter$DispatchingInvocationHandler\",\"method-name\":\"invoke\",\"file-name\":\"ProxyDispatchAdapter.java\",\"line-number\":94,\"format\":0},{\"declaring-class\":\"com.sun.proxy.$Proxy5\",\"method-name\":\"processTestClass\",\"line-number\":-1,\"format\":0},{\"declaring-class\":\"org.gradle.api.internal.tasks.testing.worker.TestWorker$2\",\"method-name\":\"run\",\"file-name\":\"TestWorker.java\",\"line-number\":176,\"format\":0},{\"declaring-class\":\"org.gradle.api.internal.tasks.testing.worker.TestWorker\",\"method-name\":\"executeAndMaintainThreadName\",\"file-name\":\"TestWorker.java\",\"line-number\":129,\"format\":0},{\"declaring-class\":\"org.gradle.api.internal.tasks.testing.worker.TestWorker\",\"method-name\":\"execute\",\"file-name\":\"TestWorker.java\",\"line-number\":100,\"format\":0},{\"declaring-class\":\"org.gradle.api.internal.tasks.testing.worker.TestWorker\",\"method-name\":\"execute\",\"file-name\":\"TestWorker.java\",\"line-number\":60,\"format\":0},{\"declaring-class\":\"org.gradle.process.internal.worker.child.ActionExecutionWorker\",\"method-name\":\"execute\",\"file-name\":\"ActionExecutionWorker.java\",\"line-number\":56,\"format\":0},{\"declaring-class\":\"org.gradle.process.internal.worker.child.SystemApplicationClassLoaderWorker\",\"method-name\":\"call\",\"file-name\":\"SystemApplicationClassLoaderWorker.java\",\"line-number\":133,\"format\":0},{\"declaring-class\":\"org.gradle.process.internal.worker.child.SystemApplicationClassLoaderWorker\",\"method-name\":\"call\",\"file-name\":\"SystemApplicationClassLoaderWorker.java\",\"line-number\":71,\"format\":0},{\"class-loader-name\":\"app\",\"declaring-class\":\"worker.org.gradle.process.internal.worker.GradleWorkerMain\",\"method-name\":\"run\",\"file-name\":\"GradleWorkerMain.java\",\"line-number\":69,\"format\":1},{\"class-loader-name\":\"app\",\"declaring-class\":\"worker.org.gradle.process.internal.worker.GradleWorkerMain\",\"method-name\":\"main\",\"file-name\":\"GradleWorkerMain.java\",\"line-number\":74,\"format\":1}],\"suppressed-exceptions\":[]},\"attachment-paths\":[],\"diagnostic-stack\":[{\"function-name\":\"jdk.internal.reflect.NativeMethodAccessorImpl.invoke0\",\"source-code\":\"4cb41569-1b17-4a69-8b48-37582c95f87a\"},{\"function-name\":\"jdk.internal.reflect.NativeMethodAccessorImpl.invoke\",\"line\":62,\"source-code\":\"792b5fee-8fd0-4686-9715-78bdcc01df34\"},{\"function-name\":\"jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke\",\"line\":43,\"source-code\":\"2356b394-c780-4c9c-9eeb-3d33de2929b8\"},{\"function-name\":\"java.lang.reflect.Method.invoke\",\"line\":566,\"source-code\":\"7bb5feae-2be1-4c9a-a173-def2dbb5224e\"},{\"function-name\":\"org.junit.runners.model.FrameworkMethod$1.runReflectiveCall\",\"line\":59,\"source-code\":\"6fc4926b-58a9-4d54-a154-660d521ab5d0\"},{\"function-name\":\"org.junit.internal.runners.model.ReflectiveCallable.run\",\"line\":12,\"source-code\":\"32e57bb6-e81c-427a-8ba3-e6982c4b157b\"},{\"function-name\":\"org.junit.runners.model.FrameworkMethod.invokeExplosively\",\"line\":56,\"source-code\":\"75f22f28-7cb4-47f8-99e5-a48d73aafe12\"},{\"function-name\":\"org.junit.internal.runners.statements.InvokeMethod.evaluate\",\"line\":17,\"source-code\":\"cbe15b23-a13d-4779-94ff-1e41edba94f3\"},{\"function-name\":\"org.junit.runners.ParentRunner$3.evaluate\",\"line\":306,\"source-code\":\"a7805b15-c619-4033-b8db-3f7f6bd17df6\"},{\"function-name\":\"org.junit.runners.BlockJUnit4ClassRunner$1.evaluate\",\"line\":100,\"source-code\":\"9a3b6b5f-9f13-44c0-9578-51606d1909c3\"},{\"function-name\":\"org.junit.runners.ParentRunner.runLeaf\",\"line\":366,\"source-code\":\"c249c6c4-fd10-44c3-975d-d3fbb592de81\"},{\"function-name\":\"org.junit.runners.BlockJUnit4ClassRunner.runChild\",\"line\":103,\"source-code\":\"37e1c09b-3130-4442-ae81-80d2b40893e0\"},{\"function-name\":\"org.junit.runners.BlockJUnit4ClassRunner.runChild\",\"line\":63,\"source-code\":\"691a9153-27ad-494c-8e97-28cf9c596431\"},{\"function-name\":\"org.junit.runners.ParentRunner$4.run\",\"line\":331,\"source-code\":\"aed30d5c-2c23-4da7-984e-9b853c0f82e1\"},{\"function-name\":\"org.junit.runners.ParentRunner$1.schedule\",\"line\":79,\"source-code\":\"ac1bf646-f881-4009-a1a9-cd8b943e3433\"},{\"function-name\":\"org.junit.runners.ParentRunner.runChildren\",\"line\":329,\"source-code\":\"dd1bad0a-521e-4b6c-9f5d-8f913817b831\"},{\"function-name\":\"org.junit.runners.ParentRunner.access$100\",\"line\":66,\"source-code\":\"0aa5b966-b70c-43f1-a644-25bad713d2b4\"},{\"function-name\":\"org.junit.runners.ParentRunner$2.evaluate\",\"line\":293,\"source-code\":\"64a86c43-bac6-4868-aa7c-f3572952a4f8\"},{\"function-name\":\"org.junit.runners.ParentRunner$3.evaluate\",\"line\":306,\"source-code\":\"3615e845-9d23-473e-bf14-273a9a9bb138\"},{\"function-name\":\"org.junit.runners.ParentRunner.run\",\"line\":413,\"source-code\":\"f6a03f68-151e-4111-8723-0652f3371ea0\"},{\"function-name\":\"org.gradle.api.internal.tasks.testing.junit.JUnitTestClassExecutor.runTestClass\",\"line\":110,\"source-code\":\"b1d4e3d3-dca9-4c3f-9d26-f399f3bf7923\"},{\"function-name\":\"org.gradle.api.internal.tasks.testing.junit.JUnitTestClassExecutor.execute\",\"line\":58,\"source-code\":\"aa1069c3-0bf4-4479-ad33-5a4053135e59\"},{\"function-name\":\"org.gradle.api.internal.tasks.testing.junit.JUnitTestClassExecutor.execute\",\"line\":38,\"source-code\":\"114a456e-88a3-4888-be52-7102794a7038\"},{\"function-name\":\"org.gradle.api.internal.tasks.testing.junit.AbstractJUnitTestClassProcessor.processTestClass\",\"line\":62,\"source-code\":\"8f10c785-6aa9-4236-bcb1-3e2bf93c524a\"},{\"function-name\":\"org.gradle.api.internal.tasks.testing.SuiteTestClassProcessor.processTestClass\",\"line\":51,\"source-code\":\"4e80f634-abf6-415c-9cce-1619dd67fc23\"},{\"function-name\":\"jdk.internal.reflect.NativeMethodAccessorImpl.invoke0\",\"source-code\":\"7c0d6267-d9f3-413c-84e2-23722e1bb223\"},{\"function-name\":\"jdk.internal.reflect.NativeMethodAccessorImpl.invoke\",\"line\":62,\"source-code\":\"3f740a13-ee55-4428-a6dd-bb803138e660\"},{\"function-name\":\"jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke\",\"line\":43,\"source-code\":\"11eb9575-b019-4484-ba11-29fc194fed49\"},{\"function-name\":\"java.lang.reflect.Method.invoke\",\"line\":566,\"source-code\":\"65afbae6-c443-4f3b-9390-6124e24f95e1\"},{\"function-name\":\"org.gradle.internal.dispatch.ReflectionDispatch.dispatch\",\"line\":36,\"source-code\":\"362cd836-732c-4c1e-af25-4f1e294253f2\"},{\"function-name\":\"org.gradle.internal.dispatch.ReflectionDispatch.dispatch\",\"line\":24,\"source-code\":\"4b005a51-0d16-426d-a367-b83dc37c13ab\"},{\"function-name\":\"org.gradle.internal.dispatch.ContextClassLoaderDispatch.dispatch\",\"line\":33,\"source-code\":\"ca109cad-f9ee-41d6-8029-379f4f01f5a8\"},{\"function-name\":\"org.gradle.internal.dispatch.ProxyDispatchAdapter$DispatchingInvocationHandler.invoke\",\"line\":94,\"source-code\":\"599b1cdc-1b45-4126-848c-c0e56e8ce8d4\"},{\"function-name\":\"com.sun.proxy.$Proxy5.processTestClass\",\"source-code\":\"f2814221-e618-4aa0-9315-60003596f658\"},{\"function-name\":\"org.gradle.api.internal.tasks.testing.worker.TestWorker$2.run\",\"line\":176,\"source-code\":\"51f5c2d0-b9cc-4176-b36b-d97a20463d3e\"},{\"function-name\":\"org.gradle.api.internal.tasks.testing.worker.TestWorker.executeAndMaintainThreadName\",\"line\":129,\"source-code\":\"d104a0f1-6da3-41b1-b442-b80373bcb1b5\"},{\"function-name\":\"org.gradle.api.internal.tasks.testing.worker.TestWorker.execute\",\"line\":100,\"source-code\":\"120f38d5-525d-4ac4-a507-442455140ce9\"},{\"function-name\":\"org.gradle.api.internal.tasks.testing.worker.TestWorker.execute\",\"line\":60,\"source-code\":\"d9d1bdb6-042b-4465-9737-2d65668632c0\"},{\"function-name\":\"org.gradle.process.internal.worker.child.ActionExecutionWorker.execute\",\"line\":56,\"source-code\":\"d4806ec1-0dab-48df-8b5d-834804fe5c43\"},{\"function-name\":\"org.gradle.process.internal.worker.child.SystemApplicationClassLoaderWorker.call\",\"line\":133,\"source-code\":\"d0f083ba-6a43-4e9c-8e2b-e0cdf8638a88\"},{\"function-name\":\"org.gradle.process.internal.worker.child.SystemApplicationClassLoaderWorker.call\",\"line\":71,\"source-code\":\"24c83e74-20eb-4a28-866c-a641dee9d245\"},{\"function-name\":\"worker.org.gradle.process.internal.worker.GradleWorkerMain.run\",\"line\":69,\"source-code\":\"fa90688b-00e1-4a2e-b5f9-038de2f3dd4f\"},{\"function-name\":\"worker.org.gradle.process.internal.worker.GradleWorkerMain.main\",\"line\":74,\"source-code\":\"88b732b6-b058-469b-8549-578818de4138\"}]}";
        // WHEN
        String json2 = BacktraceSerializeHelper.toJson(new BacktraceReport(new IllegalAccessException("test"), new HashMap<String, Object>() {{ put("test", new Exception("123")); }} ));
        BacktraceReportDeserializer deserializer = new BacktraceReportDeserializer();
        Gson g = new BacktraceGsonBuilder().buildGson();
        final long g1 = DebugHelper.getCurrentTimeMillis();
        BacktraceReport resultGson = g.fromJson(json, BacktraceReport.class);
        final long g2 = DebugHelper.getCurrentTimeMillis();

        final long c1 = DebugHelper.getCurrentTimeMillis();
        BacktraceReport resultCustom = deserializer.deserialize(new JSONObject(json));
        final long c2 = DebugHelper.getCurrentTimeMillis();

        final long g_diff = g2 - g1;
        final long c_diff = c2 - c1;
        System.out.println(" GSON took " + (g_diff) + " milliseconds");
        System.out.println(" Custom took " + (c_diff) + " milliseconds");
        // THEN
        assertNotNull(resultCustom);
        assertEquals("444d7674-378c-48fd-9b51-d961c3bba3ab", resultCustom.uuid.toString());
        assertEquals(1704905258, resultCustom.timestamp);
        assertTrue(resultCustom.exceptionTypeReport);
        assertEquals("java.lang.IllegalAccessException", resultCustom.classifier);
        assertNull(resultCustom.message);
//        assertNull(result.getBacktraceReport());
//        assertNull(result.message);
//        assertEquals(BacktraceResultStatus.Ok, result.status);
//        assertEquals("01000000-5360-240b-0000-000000000000", result.rxId);
    }
}
